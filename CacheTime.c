
/*
 * This script is useful for tuning the Spectre attack.
 * An array is created and then flushed from CPU cache.  Subsequently
 * 2 elements from the array (3*4096 and 7*4096) are read.  The access
 * time to array elements is then determined.  The two elements in
 * the array that were recently accessed remain in cache and are
 * accessed much faster than the other elements that must be pulled
 * from memroy.  We can use this difference to set a
 * threshold time that categorizes a cache hit vs a cache miss.
 *
 * Note: The spacing of 4096 between each element read is to purposely
 * exceed the size of a cache page (~64 bytes).  This is important
 * because reading element 0, is likely to cause element 1 to be cached,
 * but very unlikely to cause element 4096 to be cached.
 */

#include <stdio.h>
#include <stdint.h>
#include <emmintrin.h>
#include <x86intrin.h>

uint8_t array[10*4096];

int main(int argc, const char **argv) {
	int junk=0;
	register uint64_t time1, time2;
	volatile uint8_t *addr;
	int i;
	// Initialize the array
	for(i=0; i<10; i++) array[i*4096]=1;
	// FLUSH the array from the CPU cache
	for(i=0; i<10; i++) _mm_clflush(&array[i*4096]);
	// Access some of the array items
	array[3*4096] = 100;
	array[7*4096] = 200;

	for(i=0; i<10; i++) {
		addr = &array[i*4096];
		time1 = __rdtscp(&junk);
		junk = *addr;
		time2 = __rdtscp(&junk) - time1;
		printf("Access time for array[%d*4096]: %d CPU cycles\n",i, (int)time2);
	}
	return 0;
}

